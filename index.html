<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>swicon</title>

    <!-- <link rel="stylesheet" href="css/styles.css"> -->
    <!-- <link rel="stylesheet" href="css/page.css"> -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@3.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>


<body id="body" class="overflow:auto">
    <v-app id="app">
        <v-app-bar app color="primary" class="white--text" elevate-on-scroll absolute>
            <v-btn icon>
                <v-icon color="white">mdi-swim</v-icon>
            </v-btn>

            <v-app-bar-title>Swimming Competition Controller</v-app-bar-title>

            <v-spacer></v-spacer>

            <v-btn icon>
                <v-icon>mdi-magnify</v-icon>
            </v-btn>

        </v-app-bar>
        <v-main id="body" class="px-10 pb-10" :style="{ background: $vuetify.theme.themes.light.background }">
            <v-card elevation="2" class="mt-5">
                <v-card-title>読み込んだアドオン</v-card-title>
                <v-divider></v-divider>
                <v-list>
                    <v-list-item two-line v-for="addon in addons" :key="addon.name">
                        <!-- <v-icon color="accent">mdi-file</v-icon> -->
                        <v-list-item-icon>
                            <!-- {{addon.config.icon}} -->
                            <v-icon color="accent" v-html="addon.config.icon"></v-icon>
                        </v-list-item-icon>
                        <v-list-item-content>
                            <v-list-item-title>{{addon.name}}</v-list-item-title>
                            <v-list-item-subtitle>{{addon.config.description}}</v-list-item-subtitle>
                        </v-list-item-content>
                    </v-list-item>
                </v-list>
            </v-card>

            <v-card elevation="2" class="mt-5">
                <v-card-title>ファイルの読み込み</v-card-title>
                <v-divider></v-divider>
                <v-file-input multiple label="File input" ref="fileupload" show-size counter @change="handleFiles"
                    class="ma-8">
                </v-file-input>
                <v-divider></v-divider>
                <v-list>
                    <v-list-item two-line v-for="file in files" :key="file.name">
                        <!-- {{file.validness}} -->
                        <v-list-item-icon>
                            <v-icon color="grey" v-if="Object.values(file.validness).every(e=>e)">mdi-file</v-icon>
                            <v-icon color="red lighten-3" v-if="!Object.values(file.validness).every(e=>e)">mdi-alert
                            </v-icon>
                        </v-list-item-icon>
                        <v-list-item-content>
                            <v-list-item-title>{{file.name}}</v-list-item-title>
                            <v-list-item-subtitle>{{file.abstruct}}</v-list-item-subtitle>
                        </v-list-item-content>
                    </v-list-item>
                </v-list>
            </v-card>

            <component v-bind:is="component" v-for="component in extendUIs" :key="JSON.stringify(component)" />
        </v-main>
    </v-app>

</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>

<script src="./js/libs/xlsx.full.min.js"></script>
<script src="./js/libs/cpexcel.js"></script>
<script src="./js/scripts.js"></script>
<script src="./js/ui.js"></script>
<script src="./js/addon.js"></script>
<script src="./js/excel.js"></script>
<script src="./js/pager.js"></script>

<script>
    const qdan = (data) => {
        const ref = data[1]
        const q = data[0]
        const nos = Object.keys(q).map(e => e.replace(/\..*/, ""))
        const input = []
        const relay = []
        let no = 0
        let style = ""
        let race = "-"
        let rane = "-"
        let player = ""
        let group = ""
        let grade = ""
        let class_ = ""
        let absent = ""
        let disq = ""
        let time = []
        let table = {}
        for (const _style of Object.keys(q)) {
            for (const row of Object.values(q[_style])) {
                if (Object.values(row).includes("競技No. :")) {
                    no = row["__EMPTY_2"] || row["__EMPTY_3"]
                    if (no == 34) {
                        style = "No.34混合100m混合OP(背泳ぎ)"
                    } else {
                        style = ref.input.filter(e => e["種目"].includes(`No.${no}`))[0]["種目"]
                    }
                }
                if (Object.values(row).includes("順\r\n位")) {
                    table = {}
                    for (const key of Object.keys(row)) {
                        table[row[key]] = key
                    }
                }
                if (Object.values(row).includes("失格")) {
                    console.log(row, table)
                }
                if (style.includes("リレー")) {
                    if (parseInt(row[table["組"]]) == row[table["組"]]) {
                        const x = {
                            "種目": style,
                            "組": "-",
                            "レーン": "-",
                            "氏名": row[table["チーム名"]],
                            "所属": row[table["チーム名"]],
                            "グレード": "―",
                            "区分": "正"
                        }
                        const parse = (d) => {
                            if (!d || !d.getTime) {
                                return d
                            }
                            const format = "MMSSss"
                            return format
                                .replace("MM", ("00" + d.getMinutes()).slice(-2))
                                .replace("SS", ("00" + d.getSeconds()).slice(-2))
                                .replace("ss", ("0000" + d.getMilliseconds()).slice(-3, -1))
                        }
                        for (let i = 0; i < 8; i++) {
                            const cur = (i + 1) * 50
                            if (table[`${cur}m`] in row) {
                                x[`${cur}m`] = parse(row[table[`${cur}m`]])
                            } else {
                                x[`${cur}m`] = "ー"
                            }
                        }
                        const distanceStr = style.match(/[0-9]{2,3}m/) || ["400m"]
                        x[distanceStr[0]] = parse(row[table[`記録`]])
                        x["棄権"] = row[table[`記録`]] == "棄権" ? "" : Resultnote.CONST.JOINED
                        x["失格"] = row[table[`記録`]] == "失格" ? "" : Resultnote.CONST.QUALIFIED
                        input.push(x)
                        const y = {
                            "種目": style,
                            "組": "-",
                            "レーン": "-",
                            "チーム": row[table["チーム名"]],
                        }
                        y[`第1泳者(姓)`] = row[table[`第１泳者`]]
                        y[`第1泳者(名)`] = ""
                        y[`第2泳者(姓)`] = row[table[`第２泳者`]]
                        y[`第2泳者(名)`] = ""
                        y[`第3泳者(姓)`] = row[table[`第３泳者`]]
                        y[`第3泳者(名)`] = ""
                        y[`第4泳者(姓)`] = row[table[`第４泳者`]]
                        y[`第4泳者(名)`] = ""
                        relay.push(y)
                    }
                } else {
                    if (parseInt(row[table["組"]]) == row[table["組"]]) {
                        const x = {
                            "種目": style,
                            "組": "-",
                            "レーン": "-",
                            "氏名": row[table["氏名"]],
                            "所属": row[table["所属"]],
                            "グレード": row[table["学年"]],
                            "区分": style.includes("混合") ? "OP" : "正"
                        }
                        const parse = (d) => {
                            console.log(d)
                            if (!d || !d.getTime) {
                                return d
                            }
                            const format = "MMSSss"
                            return format
                                .replace("MM", ("00" + d.getMinutes()).slice(-2))
                                .replace("SS", ("00" + d.getSeconds()).slice(-2))
                                .replace("ss", ("0000" + d.getMilliseconds()).slice(-3, -1))
                        }
                        for (let i = 0; i < 8; i++) {
                            const cur = (i + 1) * 50
                            if (table[`${cur}m`] in row) {
                                x[`${cur}m`] = parse(row[table[`${cur}m`]])
                            } else {
                                x[`${cur}m`] = "ー"
                            }
                        }
                        const distanceStr = style.match(/[0-9]{2,3}m/) || ["400m"]
                        x[distanceStr[0]] = parse(row[table[`記録`]])
                        x["棄権"] = row[table[`記録`]] == "棄権" ? "" : Resultnote.CONST.JOINED
                        x["失格"] = row[table[`記録`]] == "失格" ? "" : Resultnote.CONST.QUALIFIED
                        input.push(x)
                    }
                }
            }
        }
        ExcelFile.simpleXlsx("record_qdan.xlsx", "result", input)
        ExcelFile.simpleXlsx("relay_qdan.xlsx", "relay", relay)
        console.log(ref, q, input)
        return
    }
    const APP = new Vue({
        el: '#app',
        vuetify: new Vuetify({
            theme: {
                themes: {
                    light: {
                        background: "#f0f0f0"
                    }
                }
            }
        }),
        data: {
            files: [],
            extendUIs: {},
            addons: []
        },
        methods: {
            async handleFiles(files) {
                if (files.length > 0) {
                    const jobs = files.map(f => ExcelFile.parse(f))
                    const data = await Promise.all(jobs)
                    this.files = files.map((_, i) => Parse(RUNTIME, files[i], data[i]))
                    console.log(this.files)
                    for (const e of Object.keys(RUNTIME.Parser)) {
                        RUNTIME.Parser[e].ui(this.files)
                    }
                    for (const e of Object.keys(RUNTIME.Parser)) {
                        const files = this.files.filter(f => f.type == e)
                        await Propagate(e, files)
                    }
                }
            }
        },
        async mounted() {
            RUNTIME.Addons = await Addon.load()
            this.addons = RUNTIME.Addons
        }
    })

</script>

</html>